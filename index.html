<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sandbox Precache Build2</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        margin-top: 50px;
      }
      #progress-container {
        width: 300px;
        margin: 20px auto;
        background: #eee;
        border-radius: 8px;
        overflow: hidden;
      }
      #progress-bar {
        width: 0;
        height: 20px;
        background: #4caf50;
      }
    </style>
  </head>
  <body>
    <h1>Build2 Precache Sandbox</h1>
    <button id="startBtn">Start Download & Cache</button>

    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>

    <script>
      const build2URL = "https://webgl-builds.github.io/SpearOnNear/";
      const unityBuild2CacheKey = "Spear-Spear On Near-3.2";

      const contentToCache = [
        "Build/tt.loader.js",
        "Build/tt.framework.js.unityweb",
        "Build/tt.data.unityweb",
        "Build/tt.wasm.unityweb",
        "TemplateData/style.css",
      ];

      let completedFiles = 0;
      let loadedBytes = new Array(contentToCache.length).fill(0);
      let totalBytes = new Array(contentToCache.length).fill(1);

      document.getElementById("startBtn").addEventListener("click", () => {
        document.getElementById("startBtn").disabled = true;
        startBuild2Download();
      });

      function startBuild2Download() {
        contentToCache.forEach((path, idx) => {
          fetch(build2URL + path)
            .then((response) => {
              if (!response.ok) throw new Error(`Failed to fetch ${path}`);

              const contentLength = response.headers.get("Content-Length");
              if (contentLength) totalBytes[idx] = parseInt(contentLength);

              const reader = response.body.getReader();
              const chunks = [];
              let received = 0;

              function read() {
                return reader.read().then(({ done, value }) => {
                  if (done) {
                    const blob = new Blob(chunks);
                    const finalResponse = new Response(blob, {
                      status: 200,
                      headers: {
                        "Content-Type": response.headers.get("Content-Type"),
                      },
                    });

                    return caches
                      .open(unityBuild2CacheKey)
                      .then((cache) => {
                        return cache.put(path, finalResponse);
                      })
                      .then(() => {
                        completedFiles++;
                        if (completedFiles === contentToCache.length) {
                          console.log(
                            "✅ All build2 files downloaded & cached."
                          );
                          updateProgress(100);
                        }
                      });
                  }

                  received += value.length;
                  loadedBytes[idx] = received;
                  chunks.push(value);

                  const percent = Math.round(
                    (loadedBytes.reduce((a, b) => a + b, 0) /
                      totalBytes.reduce((a, b) => a + b, 0)) *
                      100
                  );

                  updateProgress(percent);
                  return read();
                });
              }

              return read();
            })
            .catch((err) => {
              console.error(`❌ Error caching ${path}:`, err);
            });
        });
      }

      function updateProgress(percent) {
        document.getElementById("progress-bar").style.width = percent + "%";
      }
    </script>
  </body>
</html>
